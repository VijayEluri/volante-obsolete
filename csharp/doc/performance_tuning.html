<!doctype HTML> 
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<link href="main.css" type="text/css" rel="stylesheet">
	<title>Peformance tuning</title>
</head>

<body onload="prettyPrint()">
<div id=left-bar>
	<div id=sections>
		<center><div><a href="index.html">Volante</a></div></center>
	</div>
</div>

<div class=content>
	<p><a href=index.html>Volante</a> : <a href=devguideindex.html>Volante Developer's Guide</a> : Performance tuning</p>

	<h3>Choosing database cache size</h3>

	<p>Disk access is <a href=important_numbers.html>orders of magnitude slower</a> than memory access so the size of the cache has the biggest impact on Volante performance. Default size of the cache is 4 MB. You can change the cache size by providing <code>cacheSizeInBytes</code> argument to <code>IDatabase.Open()</code> call. Don't make it smaller than 64 kB.</p>

	<p>A bigger cache usually leads to faster operations, but keep the following in mind:
	<ul>
		<li>If a very large cache size will cause your application using all the system memory and cause swapping, performance of the whole system will degrage drastically</li>
		<li>Operating system also maintains file cache, so data is cached twice. That being said, accessing data from cache is faster than from  operating system cache because we avoid os call and context switching overhead</li>
		<li>It's not possible to have zero-sized cache. When data is accessed, it is pinned in the cache so the cache should contain enough entries to keep all pinned pages. Don't make cache size less than 64kb</li>
	</ul></p>

	<p>You can use Volante as <a href=in_memory.html>in-memory database</a> by passing <code>0</code> as <code>cacheSizeInBytes</code>.</p>

	<h3>Using larger transactions</h3>

	<p>Larger transactions (calling <code>IDatabase.Commit()</code> less frequently) also improves the performance and reduces the size of the database file.</p>

	<p>Volante uses shadow objects for changed (but not yet commited) objects. If you change the object multiple times, it's cheaper to commit only after several changes than commit after each change. In that case the shadow object will be created only once and the object will be written to disk only once.</p>

	<p>Volante groups objects into 4kB pages and reads/writes a whole page at a time. Changing only one objects causes a whole page to be modified so it's cheaper to group modification to minimize number of changed pages.</p>

	<p>The disadvantage of larger transactions is that in case of a crash, more data will be lost.</p>

	<h3>Be careful about your in-memory object graph</h3>

	<p>Usually the database root is kept in some variable during the lifetime of your program. That means that root object and all of the objects it points to will not be reclaimed by .NET garbage collector. If anywhere in your graph you reference a large number of objects e.g. as <code>IPersistent[10000] largeArray</code>, all of them will be kept in memory all the time.</p>

	<p>You can avoid that by using collections that load objects on demand. Built-in Volante collections, like <a href=indexes.html>indexes</a> or <a href=link_array_relation.html>persistent array</a> do that and efficiently manage memory.</p>

	<h3>Tuning datbase parameters</h3>

	<p>The following are properties on <code>IDatabase</code> and should be set before the database is opened. The values are in bytes.</p>

	<p><table>
		<tr><th>Parameter</th><th>Default value</th><th>Description</th></tr>
		<tr>
		<td valign=top><code>ObjectIndexInitSize</code></td>
		<td valign=top>1024</td>
		<td>Initial size of the object index. Object index is increased on demand. Reallocation of index is an expensive operation. To minimize number of reallocations, object index size is always doubled. Specifying larger initial index size allows to reduce number of future reallocations which slightly increases performance. It also leads to a larger initial size of database file. With default value of this parameter, initial database size is about 50Kb.</td></tr>

		<tr>
		<td valign=top><code>ExtensionQuantum</code></td>
		<td valign=top>4Mb</td>
		<td>Memory is allocate by scanning bitmap. If there is no large enough hole, then database is extended by the value of<code>dbDefaultExtensionQuantum</code>. Increasing the value of this parameters leads to less frequentrescanning of allocation bitmap from the very beginning. It leads to faster allocation speed and better locality of reference for created objects (because there is more chances that them will be allocated sequentially). From the other side it leads to less efficient memory usage. Reducing the value of this parameter force reusing of existed holes in memory allocation bitmap. 
		</td></tr>

		<tr>
		<td valign=top><code>ObjectCacheInitSize</code></td>
		<td valign=top>1319</td>
		<td>Volante needs object cache to check if object with a given oid already exists in memory. This cache uses weak references to allow garbage collector to reclaim memory used by objects. When a cache fill threshold is reached, cache is reallocated by doubling its size. Increasing this parameter can save some number of cache reallocations, which leads to higher performance but also higher memory use.
		</td></tr>
	</table></p>

	<center><a href=rc4encrypted.html>← encrypted database</a> &nbsp;&bull;&nbsp; <a href=history.html>history →</a></center>

	<hr style="margin-top:28px">
	<center style="font-size:10pt;color:gray">Volante is maintained by <a href="http://blog.kowalczyk.info">Krzysztof Kowalczyk</a></center>
</div>

<span id=adsense></span>
</body>
</html>
